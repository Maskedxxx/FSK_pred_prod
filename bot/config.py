"""Конфигурация Telegram бота.

Загружает настройки из переменных окружения.
Использует python-dotenv для загрузки из .env файла.

Переменные окружения:
    BOT_TOKEN: Токен Telegram бота от @BotFather
"""

from __future__ import annotations

import os
import sys
from pathlib import Path

# Добавляем корень проекта в PYTHONPATH для импорта сервисов
PROJECT_ROOT = Path(__file__).parent.parent.resolve()
if str(PROJECT_ROOT) not in sys.path:
    sys.path.insert(0, str(PROJECT_ROOT))

from dotenv import load_dotenv

# Загружаем .env из корня проекта
load_dotenv(PROJECT_ROOT / ".env")


# =============================================================================
# Telegram Bot
# =============================================================================

BOT_TOKEN: str | None = os.getenv("BOT_TOKEN")

if not BOT_TOKEN:
    raise RuntimeError(
        "BOT_TOKEN не установлен. "
        "Создайте .env файл в корне проекта с переменной BOT_TOKEN=<ваш_токен>"
    )


# =============================================================================
# Настройки пайплайна для бота
# =============================================================================

# Максимальное количество retry для VLM шага при сетевых ошибках
VLM_MAX_RETRIES: int = 2

# Таймаут ожидания между retry (секунды)
VLM_RETRY_DELAY: float = 5.0


# =============================================================================
# Текстовые сообщения бота
# =============================================================================


class Messages:
    """Централизованное хранилище текстов сообщений бота."""

    WELCOME = (
        "*Привет!*\n\n"
        "Я бот для анализа технических документов на дефекты.\n\n"
        "Нажмите кнопку *«Загрузить документ»* чтобы начать."
    )

    UPLOAD_INSTRUCTION = (
        "*Отправьте ссылку на PDF из Google Drive*\n\n"
        "Пайплайн включает 7 шагов:\n"
        "1️⃣ Скачивание PDF\n"
        "2️⃣ OCR распознавание (~3-5 мин)\n"
        "3️⃣ Поиск релевантных страниц (~30 сек)\n"
        "4️⃣ Очистка через Vision LLM (~1-2 мин)\n"
        "5️⃣ Извлечение дефектов (~1 мин)\n"
        "6️⃣ Дедупликация\n"
        "7️⃣ Генерация Excel отчёта\n\n"
        "Просто пришлите ссылку, когда будете готовы."
    )

    INVALID_LINK = (
        "*Не удалось распознать ссылку Google Drive*\n\n"
        "Проверьте, что отправляете ссылку вида:\n"
        "`https://drive.google.com/file/d/<ID>/view`"
    )

    LINK_ACCEPTED = "*Принял ссылку* — начинаю загрузку документа..."

    FALLBACK = (
        "*Бот в разработке*\n\n"
        "Отправьте ссылку на PDF из Google Drive для анализа дефектов, "
        "или нажмите кнопку *«Загрузить документ»* для инструкций."
    )

    # Шаблоны для шагов пайплайна
    STEP_DOWNLOAD_START = "*Скачиваю документ...*"
    STEP_DOWNLOAD_DONE = (
        "*Документ загружен*\n"
        "Файл: `{filename}`\n"
        "Размер: {size}\n"
        "Сессия: `{session}`"
    )

    STEP_OCR_START = "*Шаг 1/7: OCR распознавание*\nЭто займёт 3-5 минут..."
    STEP_OCR_DONE = (
        "*Шаг 1/7 завершён*\n"
        "Страниц: {pages}\n"
        "⏱ {duration:.1f} сек"
    )

    STEP_PII_START = "*Проверка персональных данных...*"
    STEP_PII_DONE_CLEAN = "*Персональные данные не обнаружены*"
    STEP_PII_DONE_MASKED = (
        "*Персональные данные замаскированы*\n"
        "Всего: {count} ({types})\n\n"
        "*По страницам:*\n{details}"
    )

    STEP_FILTER_START = "*Шаг 2/7: Поиск релевантных страниц*\n~30 секунд..."
    STEP_FILTER_DONE = (
        "*Шаг 2/7 завершён*\n"
        "Релевантных: {relevant}/{total}\n"
        "Диапазон: стр. {start}-{end}\n"
        "⏱ {duration:.1f} сек"
    )
    STEP_FILTER_NO_PAGES = (
        "*Релевантные страницы не найдены*\n\n"
        "Семантический анализ не обнаружил страниц с описанием дефектов. "
        "Пайплайн остановлен."
    )

    STEP_VLM_START = "*Шаг 3/7: Очистка через Vision LLM*\n~1-2 минуты..."
    STEP_VLM_RETRY = "Сетевая ошибка, повторяю попытку {attempt}/{max_attempts}..."
    STEP_VLM_DONE = (
        "*Шаг 3/7 завершён*\n"
        "Обработано страниц: {pages}\n"
        "⏱ {duration:.1f} сек"
    )

    STEP_EXTRACT_START = "*Шаг 4/7: Извлечение дефектов*\n~1 минута..."
    STEP_EXTRACT_DONE = (
        "*Шаг 4/7 завершён*\n"
        "Найдено дефектов: {defects}\n"
        "⏱ {duration:.1f} сек"
    )

    STEP_DEDUP_START = "*Шаг 5/7: Дедупликация*"
    STEP_DEDUP_DONE = (
        "*Шаг 5/7 завершён*\n"
        "Всего: {total}, уникальных: {unique}\n"
        "Групп дубликатов: {groups}\n"
        "⏱ {duration:.1f} сек"
    )

    STEP_EXCEL_START = "*Шаг 6/7: Генерация Excel*"
    STEP_EXCEL_DONE = "*Шаг 6/7 завершён*\n⏱ {duration:.1f} сек"

    STEP_SEND_START = "*Шаг 7/7: Отправка результата*"

    PIPELINE_DONE = (
        "*АНАЛИЗ ЗАВЕРШЁН*\n\n"
        "Документ: `{filename}`\n"
        "Страниц OCR: {ocr_pages}\n"
        "Релевантных: {relevant_pages}\n"
        "Дефектов: {defects} (уникальных: {unique})\n"
        "⏱ Общее время: {duration:.1f} сек\n"
        "Сессия: `{session}`"
    )

    ERROR_PIPELINE = "*Ошибка пайплайна:* {error}"
    ERROR_UNEXPECTED = (
        "*Произошла непредвиденная ошибка*\n\n"
        "Попробуйте позже или обратитесь к администратору."
    )
    ERROR_VLM_FAILED = (
        "*Ошибка шага VLM*\n\n"
        "Не удалось обработать страницы через Vision LLM.\n"
        "Проверьте сетевое соединение и попробуйте позже."
    )
